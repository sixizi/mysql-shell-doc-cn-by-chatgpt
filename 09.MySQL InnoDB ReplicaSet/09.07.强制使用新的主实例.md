## 9.7 强制新的主节点

与 `InnoDB Cluster` 不同，`InnoDB Cluster` 支持在主节点意外故障时自动故障转移，`InnoDB ReplicaSet` 没有自动故障检测或基于共识的协议，如 `Group Replication` 所提供的。如果主节点不可用，需要手动故障转移。一个失去了主节点的 `InnoDB ReplicaSet` 实际上是只读的，为了使任何写操作成为可能，必须选择一个新的主节点。如果您无法连接到主节点，并且您无法使用 `ReplicaSet.setPrimaryInstance()` 安全地执行切换到新主节点，如第 9.6 节“更换主节点”所述，请使用 `ReplicaSet.forcePrimaryInstance()` 操作执行强制主节点故障转移。这是一种只能在当前主节点不可用且无法以任何方式恢复的灾难性场景中使用的最后手段操作。

> **警告**
>
> 强制故障转移是一种可能具有破坏性的行动，必须谨慎使用。

如果目标实例不可达（或为 null），则自动选择最新的实例并提升为新的主节点。如果目标实例可达，则将其提升为新的主节点。其他可达的次级实例从这个新的主节点复制。目标实例必须在可达实例中拥有最新的 `GTID_EXECUTED` 集合，否则操作将失败。

故障转移与计划中的主节点更换不同，因为它提升一个次级实例而不与旧主节点同步或更新。这有以下主要后果：

- 如果旧主节点失败时，尚未由次级实例应用的任何事务将丢失。
- 如果旧主节点仍在运行并处理事务，将会发生脑裂现象，旧主和新主的数据集将分化。

如果最后已知的主节点仍然可达，`ReplicaSet.forcePrimaryInstance()` 操作将失败，以减少脑裂情况的风险。但管理员有责任确保其他实例无法访问旧主节点，以防止或最小化此类场景。

在强制故障转移后，旧主节点被新主节点视为无效，不能再成为 `ReplicaSet` 的一部分。如果您后来找到可以恢复的实例，您必须将其从 `ReplicaSet` 中移除并作为新实例添加。如果一个次级实例在故障转移期间不能切换到新的主节点，则被视为无效。

故障转移后可能会发生数据丢失，因为旧主节点可能拥有尚未复制到被提升的次级的事务。此外，如果被假定失败的实例仍然可以处理事务，例如因为其所在的网络仍然功能正常但从 `MySQL Shell` 不可达，它会继续与提升的实例发生分化。一旦实例上的事务集发生分化，恢复需要手动干预，在某些情况下甚至可能无法完成，即使失败的实例可以被恢复。通常，在需要强制故障转移的灾难中恢复，最快和最简单的方法是丢弃这些分化的事务并从新提升的主节点重新配置新实例。