## 8.5 将 MySQL Router 与 InnoDB ClusterSet 集成

MySQL Router 将客户端应用程序流量路由到 InnoDB ClusterSet 部署中的适当集群。您可以为与 InnoDB ClusterSet 部署一起使用的 MySQL Router 实例设置全局策略，并可以使用单独的 MySQL Router 实例设置来覆盖这一点。

当您针对 InnoDB ClusterSet 部署引导 MySQL Router 实例时，它会了解 ClusterSet 的完整拓扑，并能够适当地管理写和读流量。如果发生控制的切换或紧急故障转移，与 InnoDB ClusterSet 连接的 MySQL Router 实例会意识到这一点，并将流量路由到新的主集群，除了您配置为将流量发送到特定集群的任何实例之外。如果一个集群被标记为无效，MySQL Router 实例将停止向其发送读和写流量，除非您配置了在该情况下继续发送读流量的实例。

对于您与 InnoDB ClusterSet 一起使用的每个 MySQL Router 实例，您可以选择配置它以跟随主集群，或仅连接到特定的目标 InnoDB 集群。您可以使用 MySQL Shell 在线更改这些模式。

### 跟随主集群
在此模式下，MySQL Router 将应用程序流量（写和读）路由到 InnoDB ClusterSet 部署中当前为主集群的集群。这是默认模式。

### 指定目标集群
在此模式下，MySQL Router 将应用程序流量路由到您指定的 InnoDB 集群。这可以是 InnoDB ClusterSet 部署中的主集群，也可以是备份集群。如果目标集群当前是主集群，MySQL Router 打开写端口，应用程序可以写入实例。如果目标集群当前是只读的备份集群，MySQL Router 仅允许读流量，并拒绝写流量。如果由于切换或故障转移到目标集群或从目标集群发生变化，MySQL Router 相应地更改允许的请求类型。此模式适用于只进行读请求的应用程序，这些请求可以在备份集群上进行，并且您希望将该流量路由到本地集群。

您还可以配置 MySQL Router，以允许或禁止向被标记为 INVALIDATED 的集群发送读流量。在此状态下的集群当前完全不作为 InnoDB ClusterSet 部署的一部分运行，并且不能接收写操作。尽管集群不一定有任何技术问题，但其数据正在变得陈旧。默认情况下，MySQL Router 禁止向无效集群发送读写流量（`drop_all` 设置），但您可以选择允许读取（`accept_ro` 设置）。

要针对 InnoDB ClusterSet 引导 MySQL Router，您需要使用 InnoDB 集群管理员账户，或具有所需权限的 InnoDB 集群服务器配置账户。然后 MySQL Router 使用 MySQL Router 管理员账户连接到 InnoDB ClusterSet 部署中的实例。在引导操作期间，您需要指定这两个账户的用户名和密码。有关更多信息，请参见第8.3节“InnoDB ClusterSet 的用户账户”。

### 重要提示
如果您在 InnoDB ClusterSet 部署中使用现有的 InnoDB 集群作为主集群，并且已经针对该集群引导了 MySQL Router，请按照此过程的相关部分使用 `--force` 选项再次引导它，然后停止并重新启动 MySQL Router。MySQL Router 实例的静态配置文件中的设置需要为 InnoDB ClusterSet 更新。

要将 MySQL Router 与 InnoDB ClusterSet 部署集

成，请按照此过程操作：

1. 如果您还没有这样做，请根据您的拓扑适当安装 MySQL Router 实例。推荐的 MySQL Router 部署是在客户端应用程序的同一主机上。在使用沙盒部署时，一切都运行在单个主机上，因此您将 MySQL Router 部署到同一主机。在使用生产部署时，我们建议在托管您的客户端应用程序之一的每台机器上部署一个 MySQL Router 实例。也可以通过应用程序实例连接的公共机器部署 MySQL Router。

2. 使用 InnoDB 集群管理员账户连接到 InnoDB ClusterSet 部署中的任何活动成员服务器实例。您也可以使用具有所需权限的 InnoDB 集群服务器配置账户。使用 `dba.getClusterSet()` 或 `cluster.getClusterSet()` 命令获取 ClusterSet 对象。

3. 验证 InnoDB ClusterSet 部署是否健康，方法是在连接到集群中的任何成员服务器时在 MySQL Shell 中发出 `clusterSet.status()`。例如：

```sql
mysql-js> myclusterset.status({extended: 1})
```

4. 对于每个 MySQL Router 实例，在安装 MySQL Router 的实例上运行 mysqlrouter 命令，针对 InnoDB ClusterSet 引导 MySQL Router。

5. 引导每个 MySQL Router 实例后，验证它现在是否正确地针对 InnoDB ClusterSet 部署进行了引导，方法是在连接到 InnoDB ClusterSet 中的任何成员服务器时在 MySQL Shell 中发出 `myclusterset.listRouters()`。

6. 要查看为每个 MySQL Router 实例设置的路由选项以及 InnoDB ClusterSet 部署的全局策略，请在连接到 InnoDB ClusterSet 部署中的任何成员服务器时在 MySQL Shell 中发出 `myclusterset.routingOptions()`。

7. 如果您想改变全局路由策略或个别 MySQL Router 实例的路由策略，请在连接到 InnoDB ClusterSet 部署中的任何成员服务器时在 MySQL Shell 中发出 `myclusterset.setRoutingOption()`。

准备开始接受连接时，将应用程序配置为使用 MySQL Router 监听 InnoDB ClusterSet 部署流量的端口。然后在安装了 MySQL Router 的服务器上使用适当的 shell 或脚本启动 MySQL Router 实例。