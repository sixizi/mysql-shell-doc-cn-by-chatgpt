8.9.3 修复 InnoDB ClusterSet 成员服务器和集群

根据集群的问题或维护需求，以下操作可供您处理其成员服务器。除非另有说明，否则使用您用 InnoDB 集群管理员帐户或服务器配置帐户获取的 Cluster 和 ClusterSet 对象，以便存储在 ClusterSet 对象中的默认用户帐户具有正确的权限。

使用 cluster.addInstance() 命令将更多服务器实例添加到集群中，如“部署 InnoDB ClusterSet”第 8.4 节中的程序所述。有关该命令的更多详细信息，请参见第 7.4.4 节 “向 InnoDB 集群添加实例”。

请注意，对于此操作，您需要使用 InnoDB 集群服务器配置帐户和使用该帐户获取的 Cluster 对象。该帐户还必须存在于服务器实例上，如第 8.3 节 “InnoDB ClusterSet 的用户帐户”中所解释。

当您使用此命令将成员服务器添加到 InnoDB 集群（该集群是 InnoDB ClusterSet 部署的一部分）时，服务器实例被添加到集群中，并用 InnoDB ClusterSet 的数据进行配置。在实例上设置 ClusterSet 复制通道，并应用在 InnoDB ClusterSet 部署中操作所需的配置。

使用 cluster.rejoinInstance() 命令重新加入之前是集群一部分但无法自动重新加入集群的服务器实例。有关此操作的详细信息，请参见第 7.8.1 节 “重新加入实例到集群”。

当您使用此命令将成员服务器重新加入到 InnoDB 集群（该集群是 InnoDB ClusterSet 部署的一部分）时，服务器实例被重新加入到集群中，并用 InnoDB ClusterSet 的数据进行配置。在实例上设置 ClusterSet 复制通道，并应用在 InnoDB ClusterSet 部署中操作所需的配置。

使用 cluster.removeInstance() 命令从集群中移除服务器实例。指定要移除的服务器实例的主机名和端口号。有关此操作的详细信息，请参见从 InnoDB 集群中移除实例。有一个强制选项可用，但应仅作为最后手段使用。

当您在 InnoDB ClusterSet 部署中对成员服务器使用此命令时，MySQL Shell 将重置为 InnoDB ClusterSet 应用的所有配置，并重置 ClusterSet 复制通道设置。

使用 cluster.setPrimaryInstance(instance) 命令更改集群的主服务器。更换主服务器可以让您对当前的主服务器进行维护和升级，或者如果 Group Replication 自己的选举过程没有自动选出您想要的主服务器，可以选择一个主服务器。

指定要成为主服务器的服务器实例的主机名和端口号。从 MySQL Shell 8.0.29 开始，您可以使用 runningTransactionsTimeout 选项为使用该函数时运行的事务指定 0 到 3600 秒的超时时间，这也会停止新的传入事务。没有超时的默认设置，所以如果您不设置它，对于操作的等待时间没有上限，且在此期间可以开始新的事务。

当您在 InnoDB ClusterSet 部署中对成员服务器使用此命令时，MySQL Shell 事先停止服务器上的 ClusterSet 复制通道，并在之后重新启动它。此外，如果集群是复制集群，MySQL Shell 将保持主服务器为只读，而不是使其读写，正如通常情况下 InnoDB 集群的主服务器那样。

使用 cluster.forceQuorumUsingPartitionOf(instance) 命令通过剩余实例强制达成仲裁来恢复丢失仲裁的集群。指定具有正确元数据的在线服务器实例的主机名和端口号。该操作使集群由此实例和其他可达实例组成，并排除被分区的实例。这个操作可能会创建一个脑裂场景，因此应被视为最后手段。有关此操作的详细信息，请参见第 7.8.2 节 “从仲裁丢失中恢复集群”。

当您在 InnoDB ClusterSet 部署中对成员服务器使用此命令时，MySQL Shell 检查目标集群是否仍然是 ClusterSet 的有效部分，并在它被作废时警告您。此外，操作后它还会自动重新启动 ClusterSet 复制通道。如果集群是复制集群，MySQL Shell 将保持主服务器为只读，而不是使其读写，正如通常情况下 InnoDB 集群的主服务器那样。

使用 dba.rebootClusterFromCompleteOutage() 命令重新启动完全离线的集群。有关此操作的详细信息，请参见第 7.8.3 节 “从重大故障中重启集群”。

当您在 InnoDB ClusterSet 部署中对成员服务器使用此命令时，MySQL Shell 检查目标集群是否仍然是 ClusterSet 的有效部分，并在它被作废时警告您。

如果集群没有被作废，MySQL Shell 在重启后立即将其重新加入到 InnoDB ClusterSet 部署中。如果集群被作废，您必须使用 clusterSet.rejoinCluster() 操作将其重新加入到 InnoDB ClusterSet 部署中。有关如何执行此操作的说明，请参见第 8.9.5 节 “将集群重新加入到 InnoDB ClusterSet”。

MySQL Shell 还会在此操作后自动重新启动 ClusterSet

 复制通道。如果集群是复制集群，MySQL Shell 将保持主服务器为只读，而不是使其读写，正如通常情况下 InnoDB 集群的主服务器那样。

除非它是 ClusterSet 中唯一的集群或集群被作废，否则您不能解散当前是 InnoDB ClusterSet 部署一部分的 InnoDB 集群。在所有其他配置中，您必须按照第 8.9.4 节 “从 InnoDB ClusterSet 中移除集群”中描述的从 InnoDB ClusterSet 中移除它。

截至 MySQL Shell 8.0.32，如果集群是 ClusterSet 中唯一的集群或集群被作废，您可以在集群上使用 dba.dropMetadataSchema() 或 cluster.dissolve()。